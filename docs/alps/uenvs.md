# User Environments

Software stacks at CSCS are now accessible through the so-called User Environments (uenv). They replace the previous monolithic software stack containing everything from which one could load any module, with all the infinite potential conflicts it involves. User environments contain the minimal software stack required for a certain activity, say, building and running ICON. They are generated by `spack`, packed into single files by `squashfs` and then mounted by the user. In a way, they can be considered as poor mans containers.

!!! success "Main Advantages of Uenvs"

    - a much reduced maintenance
    - system-wide upgrades are limited to the low level OS, so should be way easier, when not transparent to the users
    - upgrading to more recent software stacks or keeping old ones around (think compiler versions) is way easier
    - users (for now C2SM) are able to build their own uenvs
    - quicker access to software compared to classical multi-files directories

## `uenv` command line tool

[:material-link: Official documentation :material-open-in-new:](https://eth-cscs.github.io/uenv/){:target="_blank"}

The user environments are registered in a database. The `uenv` command line tool can be used to

 - query images by metadata: tags, names, target architecture, etc ...
 - mount images and work interactively
 - run a single command with that uenv mounted
 - access uenv modules
 
 For now, `uenv` isn't available on Balfrin and requires (easy) [manual installation :material-open-in-new:](https://eth-cscs.github.io/uenv/#getting-uenv){:target="_blank"}
 
### useful commands

```shell
uenv image inspect prgenv-gnu --format="{sqfs}"
/bret/scratch/cscs/bcumming/.uenv-images/images/1736b4bb5ad9b3c5cae8878c71782a8bf2f2f739dbce8e039b629de418cb4dab/store.squashfs
```

## `uenv` SLURM plugin

In order to have a uenv mounted at runtime for slurm jobs, use the `--uenv` slurm plugin developped by CSCS:

```shell
sbatch --uenv /image/path:/mount/point
```

The `:/mount/point` can always be omitted and defaults to `/user-environment`.

Later on, the plugin will accept images tags as well as paths. For now:
```shell
srun --uenv=$(uenv image inspect prgenv-gnu --format="{sqfs}")
```

## Mount points

`uenv`s cannot be mounted *anywhere*. They are generated with a predefined installation path contained in it, where the user is supposed to mount them, at least if they are used as a spack instance (don't know for other usage). By default, it's `/user-environment` and another `/user-tools` also exists for *side* environments that would potentially need to be mounted simultaneously to a *main* one.

## Build your own

[:material-link: Official stackinator documentation :material-open-in-new:](https://eth-cscs.github.io/stackinator/){:target="_blank"}

Uenvs are generated using the `stackinator` tool and official CSCS recipes are stored in the [`alps-uenv` repo :material-open-in-new:](https://github.com/eth-cscs/alps-uenv){:target="_blank"}. A CI pipeline is in place on this repo that triggers the build of software stack images upon PR. Images are then added to the uenvs registry so that users can query them by metadata. This github action is accessible to whitelisted users and Matthieu will be added to them.

!!! note "TODO"

    - [ ] Instructions for stackinator usage
    - [ ] Instructions for CI pipeline

## `spack-c2sm` integration

!!! note "TODO"

    - `source setup-env.sh /user-environment`
    - Mount the same uenv image at build and run time
