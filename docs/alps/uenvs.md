!!! construction "Page under construction"

    Information in this page is not yet complete nor final. It will be updated following the progress of

    - the Alps system deployment at CSCS
    - C2SM's adaptation to this new system

# User Environments

Software stacks at CSCS are now accessible through the so-called User Environments (uenv). They replace the previous monolithic software stack containing everything from which one could load any module, with all the infinite potential conflicts it involves. User environments contain the minimal software stack required for a certain activity, say, building and running ICON. They are generated by `spack`, packed into single `squashfs` file and then mounted by the user. In a way, they can be considered as poor man's containers.

!!! success "Main Advantages of Uenvs"

    To a large degree, we can consider that there is a separation of concerns between software stacks and the machine OS which enables the following:

    - a much reduced maintenance of software stacks
    - system-wide upgrades are limited to the low level OS, so should be way easier, when not transparent to the users
    - upgrading to more recent software stacks or keeping old ones around (think compiler versions) is way easier
    - users (for now C2SM) are able to build their own uenvs
    - quicker access to software compared to classical multi-files directories
    
## CSCS documentation

A description of user environments and the `uenv` tool can be found in the [CSCS Knowledge Base :material-open-in-new:](https://confluence.cscs.ch/display/KB/UENV+user+environments){:target="_blank"}. 

## Uenvs central Registry and C2SM uenvs

The user environments provided by CSCS are registered in a central database. In the long run we should be able to operate only with those but, at least for the initial period, there is also the need for uenvs provided by C2SM. These are accessed by their absolute path. All supported uenvs are documented in the corresponding vClsuter section of the [dedicated page](../vclusters/){:target="_blank"}. 

## The `uenv` command line tool

[Official documentation :material-open-in-new:](https://eth-cscs.github.io/uenv/){:target="_blank"}

It can be used to

- query images by metadata: tags, names, target architecture, etc ...
- mount images and work interactively
- run a single command with that uenv mounted
- access uenv modules
 
For now, `uenv` isn't available on Balfrin and requires (easy) [manual installation :material-open-in-new:](https://eth-cscs.github.io/uenv/#getting-uenv){:target="_blank"}.

!!! note "TODO: Quick start"

    - [ ] `uenv image repo create`
    - [ ] `uenv image find`
    - [ ] `uenv image pull`
    - [ ] `uenv start`
    - [ ] `uenv run`

## `--uenv` SLURM plugin

CSCS developped the `--uenv` slurm plugin in order to mount uenvs at runtime. Either use the name of a uenv in your local repo or the full absolute path to the uenv.

```shell
sbatch --uenv uenv_name:/mount/point
sbatch --uenv /image/path:/mount/point
```

`:mount/point` can always be omitted and defaults to `:/user-environment`.

On Balfrin, the installed plugin version doesn't allow access via uenv names but `uenv image inspect` can be used to query the corresponding absolute path:

```shell
uenv image inspect prgenv-gnu --format="{sqfs}"
/bret/scratch/cscs/bcumming/.uenv-images/images/1736b4bb5ad9b3c5cae8878c71782a8bf2f2f739dbce8e039b629de418cb4dab/store.squashfs
```

## Mount points

Uenvs cannot be mounted *anywhere*. They are generated with a predefined installation path contained in it, where the user is supposed to mount them, at least if they are used as a spack instance (don't know for other usage). By default, it is `/user-environment` and another `/user-tools` also exists for *side* environments that would potentially need to be mounted simultaneously to a *main* one.

## `spack-c2sm` integration

User environments are used as a spack upstream with
```shell
source spack-c2sm/setup-env.sh /user-environment
``` 

!!! note "TODO"

    - [ ] Update official `spack-c2sm` documentation
